---
title: 'Construyendo un Nodo n8n para Wasapi: De Caos a Arquitectura SOLID'
description: 'De desarrollador frustrado a arquitecto de software: C√≥mo transform√© un proyecto de integraci√≥n de WhatsApp en una obra maestra de c√≥digo limpio que pas√≥ los primeros checks de verificaci√≥n de n8n'
published: 2025-10-02
tags: ['n8n', 'wasapi', 'whatsapp', 'typescript', 'solid', 'dto', 'arquitectura']
series: 'Automatizaci√≥n con n8n'
---

> C√≥mo transform√© un proyecto ca√≥tico de integraci√≥n de WhatsApp en una arquitectura SOLID que super√≥ los primeros checks de verificaci√≥n de n8n

## El Desaf√≠o

Necesitaba integrar **Wasapi** (API de WhatsApp Business) con **n8n**, pero no exist√≠an nodos comunitarios. La documentaci√≥n era escasa y cada error me llevaba a horas de debugging.

**Los n√∫meros que me motivaron:**
- **25+ operaciones** de WhatsApp Business API
- **0 nodos comunitarios** existentes para Wasapi

## Los Primeros D√≠as: El Caos Total

**Error #1: Todo en un Solo Archivo**
```typescript
// ‚ùå MI PRIMER INTENTO (DESASTRE TOTAL)
export class WasapiNode {
  async execute() {
    // 500+ l√≠neas de c√≥digo mezclado
    // Validaciones hardcodeadas
    // L√≥gica de negocio mezclada con UI
    // Imposible de mantener
  }
}
```

**¬øQu√© sali√≥ mal?**
- C√≥digo imposible de leer
- Testing era una pesadilla
- Cada cambio romp√≠a todo
- Debugging era como buscar una aguja en un pajar


## El Momento Eureka: Descubriendo los DTOs

Despu√©s de evaluar varias opciones, me top√© con el patr√≥n **DTO (Data Transfer Object)**.

```typescript
// ‚úÖ MI NUEVA APROXIMACI√ìN CON DTOs
export class ContactDTO {
  static create(executeFunctions: IExecuteFunctions, index: number): ContactData {
    return {
      first_name: executeFunctions.getNodeParameter('first_name', index) as string,
      last_name: executeFunctions.getNodeParameter('last_name', index) as string,
      email: executeFunctions.getNodeParameter('email', index) as string,
      phone: executeFunctions.getNodeParameter('phone', index) as string,
      notes: executeFunctions.getNodeParameter('notes', index) as string,
      labels: executeFunctions.getNodeParameter('labels', index) as number[],
      custom_fields: {},
    };
  }
}
```

**¬øPor qu√© esto resolvi√≥ el problema?**
- **Separaci√≥n de responsabilidades**: Los DTOs solo se encargan de transformar datos
- **Reutilizaci√≥n**: Un DTO puede ser usado en m√∫ltiples operaciones
- **Testing**: F√°cil de testear de forma aislada
- **Mantenibilidad**: Cambios en la estructura de datos se centralizan

## Aplicando Principios SOLID

1. Single Responsibility Principle (SRP)
```typescript
// ‚úÖ CADA CLASE TIENE UNA RESPONSABILIDAD ESPEC√çFICA
export class ContactDTO {
  // Solo se encarga de transformar datos de contacto
}

export class ContactValidator {
  // Solo se encarga de validar datos de contacto
}

export class ContactService {
  // Solo se encarga de la l√≥gica de negocio de contactos
}
```

2. Open/Closed Principle (OCP)
```typescript
// ‚úÖ F√ÅCIL DE EXTENDER SIN MODIFICAR C√ìDIGO EXISTENTE
export class OperationFactory {
  private static operations: Map<string, OperationHandler> = new Map([
    [OPERATION_KEYS.CONTACT_CREATE, { execute: executeContactCreate }],
    [OPERATION_KEYS.CONTACT_GET, { execute: executeGetContact }],
    // F√°cil agregar nuevas operaciones sin tocar las existentes
  ]);
}
```

3. Dependency Inversion Principle (DIP)
```typescript
// ‚úÖ DEPENDENCIA DE ABSTRACCIONES
export class ContactService {
  constructor(private client: WasapiClient) {} // Depende de la interfaz, no de la implementaci√≥n
  
  async createContact(data: ContactData): Promise<any> {
    return await this.client.contacts.create(data);
  }
}
```

## Los Desaf√≠os M√°s Grandes

Desaf√≠o #1: La Naturaleza No Reactiva de n8n
**El problema**: n8n no es reactivo como Make. No puedes crear campos din√°micos de la misma manera.

```typescript
// ‚ùå LO QUE QUER√çA HACER (como en Make)
const dynamicFields = await api.getFields();

// ‚úÖ LO QUE TUVE QUE HACER EN n8n
export const contactCreateProperties: INodeProperties[] = [
  {
    displayName: 'Custom Fields',
    name: 'custom_fields',
    type: 'fixedCollection',
    // ... configuraci√≥n est√°tica
  }
];
```

**La soluci√≥n**: Crear un sistema de `loadOptions` robusto:
```typescript
export async function getCustomFields(this: ILoadOptionsFunctions) {
  const client = await createClient(this);
  
  if (!client) {
    return [{ name: '‚ùå First Configure Credentials', value: '' }];
  }

  try {
    const response = await client.customFields.getAll();
    return response.data.map((field: any) => ({
      name: field.field_name,
      value: field.field_name,
    }));
  } catch (error: any) {
    return handleLoadOptionsError(error);
  }
}
```

Desaf√≠o #2: Separaci√≥n de Propiedades
**El problema**: Con 25+ operaciones, las propiedades se volvieron un desastre.

**La soluci√≥n**: Arquitectura modular:
```typescript
// ‚úÖ ARQUITECTURA MODULAR DE PROPIEDADES
export const allProperties: INodeProperties[] = [
  resourceOptions,
  ...campaignsProperties,
  ...contactProperties,
  ...customFieldsProperties,
  ...labelsProperties,
  ...whatsappProperties,
  ...userProperties,
  ...agentsProperties,
];
```

Desaf√≠o #3: Migraci√≥n del SDK a HTTP Directo
```typescript
// ‚ùå MI PRIMER ENFOQUE (SDK)
import { WasapiClient } from '@wasapi/js-sdk';

// ‚úÖ ENFOQUE FINAL (HTTP DIRECTO)
export class N8nHttpClient implements IN8nHttpClient {
    private baseURL: string;
    private headers: Record<string, string>;

    constructor(apiKey: string, baseURL?: string, private executeFunctions?: IExecuteFunctions) {
        // Validate that API key is not empty
        if (!apiKey || apiKey.trim() === '') {
            throw new Error('WasAPI: API key is required and cannot be empty');
        }

        // Set default baseURL if not provided
        this.baseURL = baseURL || 'https://api-ws.wasapi.io/api/v1';

        // Set headers
        this.headers = {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
        };
    }

// ...
}

```

## Lecciones Aprendidas

1. Los DTOs No Son Solo para Transferir Datos
Son la base de una arquitectura limpia y mantenible.

2. Los Principios SOLID No Son Teor√≠a
Son herramientas pr√°cticas que resuelven problemas reales.

3. n8n No Es Reactivo Por Dise√±o - Y Eso Est√° Bien
No intentes luchar contra la arquitectura de n8n. Abr√°zala y √∫sala a tu favor.

4. LoadOptions Requieren Planificaci√≥n Cuidadosa
No son reactivos, se ejecutan en tiempo de ejecuci√≥n. Planifica bien tu flujo de datos.

5. La Separaci√≥n de Propiedades Es Cr√≠tica
Con 25+ operaciones, un archivo de propiedades se vuelve inmanejable r√°pidamente.


## Reflexiones Finales

Este proyecto me ense√±√≥ que **la arquitectura de software no es solo para empresas grandes**. Incluso en proyectos peque√±os, aplicar principios s√≥lidos y patrones de dise√±o puede marcar la diferencia entre un c√≥digo mantenible y un desastre total.

**Los DTOs y los principios SOLID no son solo teor√≠a** - son herramientas pr√°cticas que resuelven problemas reales y hacen que el desarrollo sea m√°s placentero y eficiente.

**Lo M√°s Valioso que Aprend√≠:**

1. **n8n tiene una filosof√≠a diferente a Make** - y eso est√° bien. Cada plataforma tiene sus fortalezas.

2. **Los loadOptions requieren planificaci√≥n cuidadosa** - no son reactivos, pero con la arquitectura correcta, son incre√≠blemente poderosos.

3. **La separaci√≥n de propiedades es cr√≠tica** - con 25+ operaciones, la organizaci√≥n modular no es opcional, es necesaria.

4. **A veces HTTP directo es mejor que SDKs** - cuando necesitas control granular sobre errores y timeouts.

**El Impacto Real:**
- ‚úÖ **25+ operaciones** funcionando perfectamente
- ‚úÖ **Arquitectura escalable** que puede crecer
- ‚úÖ **C√≥digo mantenible** que otros pueden entender
- ‚úÖ **Primeros checks aprobados** por el equipo de n8n
- üü° **En proceso de verificaci√≥n** para la comunidad

**¬øQuieres Ver el C√≥digo?**
El proyecto completo est√° disponible en GitHub: [n8n-nodes-wasapi](https://github.com/Vinix-Code-Dev/n8n-nodes-wasapi)

